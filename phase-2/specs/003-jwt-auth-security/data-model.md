# Data Model: Security, Authentication & Data Isolation

**Feature Branch**: `003-jwt-auth-security`
**Created**: 2026-01-13

---

## Security Entities

### Entity: User (Managed by Better Auth)

Better Auth automatically creates and manages the `user` table. This entity is the source of truth for user identity.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | VARCHAR(36) | PRIMARY KEY | UUID generated by Better Auth |
| email | VARCHAR(255) | UNIQUE, NOT NULL | User's email address |
| emailVerified | BOOLEAN | DEFAULT FALSE | Email verification status |
| name | VARCHAR(255) | NULLABLE | User's display name |
| image | VARCHAR(255) | NULLABLE | Profile image URL |
| createdAt | TIMESTAMP | NOT NULL | Account creation time |
| updatedAt | TIMESTAMP | NOT NULL | Last update time |

**Managed By**: Better Auth (do not modify directly)

---

### Entity: Session (Managed by Better Auth)

Better Auth manages sessions in the `session` table. Sessions are used to track active logins and generate JWT tokens.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | VARCHAR(36) | PRIMARY KEY | Session UUID |
| userId | VARCHAR(36) | FOREIGN KEY → user.id | Owner of session |
| token | TEXT | NOT NULL | Session token (may contain JWT) |
| expiresAt | TIMESTAMP | NOT NULL | Session expiration time |
| ipAddress | VARCHAR(45) | NULLABLE | Client IP address |
| userAgent | TEXT | NULLABLE | Client user agent |
| createdAt | TIMESTAMP | NOT NULL | Session creation time |
| updatedAt | TIMESTAMP | NOT NULL | Last activity time |

**Managed By**: Better Auth (do not modify directly)

---

### Entity: Account (Managed by Better Auth)

Better Auth uses the `account` table for authentication providers (email/password in our case).

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | VARCHAR(36) | PRIMARY KEY | Account UUID |
| userId | VARCHAR(36) | FOREIGN KEY → user.id | Owner of account |
| accountId | VARCHAR(255) | NOT NULL | Provider-specific ID |
| providerId | VARCHAR(255) | NOT NULL | Provider name (e.g., "credential") |
| password | TEXT | NULLABLE | Hashed password (for email/password) |
| createdAt | TIMESTAMP | NOT NULL | Account creation time |
| updatedAt | TIMESTAMP | NOT NULL | Last update time |

**Managed By**: Better Auth (do not modify directly)

---

### Entity: Todo (Application-Managed)

The `todo` table includes a `user_id` foreign key for ownership enforcement.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | Task ID |
| title | VARCHAR(255) | NOT NULL, MIN 1, MAX 255 | Task title |
| description | TEXT | NULLABLE | Task description |
| completed | BOOLEAN | DEFAULT FALSE | Completion status |
| user_id | VARCHAR(36) | FOREIGN KEY → user.id, NOT NULL | Task owner |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Creation time |
| updated_at | TIMESTAMP | ON UPDATE CURRENT_TIMESTAMP | Last update |

**Data Isolation Rules**:
- All queries MUST filter by `user_id = authenticated_user.id`
- Insert MUST set `user_id` from JWT token `sub` claim
- Update/Delete MUST verify `user_id` matches before proceeding
- 403 Forbidden returned if ownership check fails

---

## JWT Token Structure

### Claims (Payload)

| Claim | Type | Required | Description |
|-------|------|----------|-------------|
| sub | string | YES | User ID (from user.id) |
| email | string | NO | User email (from user.email) |
| name | string | NO | User name (from user.name) |
| iat | number | YES | Issued at (Unix timestamp) |
| exp | number | YES | Expiration (Unix timestamp) |

### Example Token Payload

```json
{
  "sub": "usr_abc123xyz789",
  "email": "user@example.com",
  "name": "John Doe",
  "iat": 1736726400,
  "exp": 1737331200
}
```

---

## Validation Rules

### User Registration
- Email: Valid email format (RFC 5322)
- Email: Must be unique (no duplicates)
- Password: Minimum 8 characters
- Password: Stored as bcrypt hash (Better Auth handles this)

### JWT Token
- Must contain `sub` claim (user ID)
- Must be signed with shared secret (HS256)
- Must not be expired (`exp` > current time)
- Must have valid signature (verified against JWT_SECRET)

### Data Isolation
- All todo operations require valid JWT
- `user_id` automatically set from token on create
- Read/Update/Delete verify `user_id` matches token's `sub`
- Cross-user access returns HTTP 403 Forbidden

---

## Entity Relationships

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    User      │────<│   Session    │     │   Account    │
│  (Better     │ 1:N │  (Better     │     │  (Better     │
│   Auth)      │     │   Auth)      │     │   Auth)      │
└──────┬───────┘     └──────────────┘     └──────────────┘
       │ 1:N                                     │
       │                                         │
       ▼                                         │
┌──────────────┐                                 │
│    Todo      │                                 │
│  (App Data)  │<────────────────────────────────┘
│              │         user_id FK
└──────────────┘
```

**Relationships**:
- User 1:N Session (user can have multiple active sessions)
- User 1:N Account (user can have multiple auth providers)
- User 1:N Todo (user owns many tasks)

---

## Security Invariants

1. **No direct user table modification**: Better Auth manages user lifecycle
2. **Password never in JWT**: Only user ID and optional profile fields
3. **Session creates JWT**: Token generated when session is created/refreshed
4. **Stateless verification**: Backend verifies signature only, no DB lookup
5. **Ownership enforced at query level**: Every SQL includes `WHERE user_id = ?`
